ç›®æ ‡æ£€æµ‹çš„ä¸»è¦ç›®çš„æ˜¯è®©è®¡ç®—æœºå¯ä»¥è‡ªåŠ¨è¯†åˆ«å›¾ç‰‡æˆ–è€…è§†é¢‘å¸§ä¸­æ‰€æœ‰ç›®æ ‡çš„ç±»åˆ«ï¼Œå¹¶åœ¨è¯¥ç›®æ ‡å‘¨å›´ç»˜åˆ¶è¾¹ç•Œæ¡†ï¼Œæ ‡ç¤ºå‡ºæ¯ä¸ªç›®æ ‡çš„ä½ç½®

![1715066873046](image/03ç›®æ ‡æ£€æµ‹/1715066873046.png)å¯¹äºç›®æ ‡æ£€æµ‹é—®é¢˜ï¼ŒæŒ‰ç…§ **å›¾2** çš„æµç¨‹åˆ™è¡Œä¸é€šï¼Œå› ä¸ºåœ¨å›¾åƒåˆ†ç±»ä»»åŠ¡ä¸­ï¼Œå¯¹æ•´å¼ å›¾æå–ç‰¹å¾çš„è¿‡ç¨‹ä¸­æ²¡èƒ½ä½“ç°å‡ºä¸åŒç›®æ ‡ä¹‹é—´çš„åŒºåˆ«ï¼Œæœ€ç»ˆä¹Ÿå°±æ²¡æ³•åˆ†åˆ«æ ‡ç¤ºå‡ºæ¯ä¸ªç‰©ä½“æ‰€åœ¨çš„ä½ç½®ã€‚

å°†ç›®æ ‡æ£€æµ‹ä»»åŠ¡è¿›è¡Œæ‹†åˆ†

R-CNNçš„ç³»åˆ—ç®—æ³•åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œå…ˆåœ¨å›¾åƒä¸Šäº§ç”Ÿå€™é€‰åŒºåŸŸï¼Œå†å¯¹å€™é€‰åŒºåŸŸè¿›è¡Œåˆ†ç±»å¹¶é¢„æµ‹ç›®æ ‡ç‰©ä½“ä½ç½®ï¼Œå®ƒä»¬é€šå¸¸è¢«å«åšä¸¤é˜¶æ®µæ£€æµ‹ç®—æ³•ã€‚

SSDå’ŒYOLOç®—æ³•åˆ™åªä½¿ç”¨ä¸€ä¸ªç½‘ç»œåŒæ—¶äº§ç”Ÿå€™é€‰åŒºåŸŸå¹¶é¢„æµ‹å‡ºç‰©ä½“çš„ç±»åˆ«å’Œä½ç½®ï¼Œæ‰€ä»¥å®ƒä»¬é€šå¸¸è¢«å«åšå•é˜¶æ®µæ£€æµ‹ç®—æ³•ã€‚

# ç›®æ ‡æ£€æµ‹åŸºç¡€æ¦‚å¿µ

## è¾¹ç•Œæ¡†ï¼ˆbounding boxï¼‰

æ£€æµ‹ä»»åŠ¡éœ€è¦åŒæ—¶é¢„æµ‹ç‰©ä½“çš„ç±»åˆ«å’Œä½ç½®ï¼Œè¾¹ç•Œæ¡†ï¼ˆbounding boxï¼Œbboxï¼‰æ¥è¡¨ç¤ºç‰©ä½“çš„ä½ç½®ï¼Œè¾¹ç•Œæ¡†æ˜¯æ­£å¥½èƒ½åŒ…å«ç‰©ä½“çš„çŸ©å½¢æ¡†

ä¸¤ç§è¡¨ç¤ºæ ¼å¼ï¼š

****(**x**1****,**y**1,**x**2,**y**2)ï¼Œå…¶ä¸­(ğ‘¥1,ğ‘¦1)******æ˜¯çŸ©å½¢æ¡†å·¦ä¸Šè§’çš„åæ ‡ï¼Œ(ğ‘¥2,ğ‘¦2)**æ˜¯çŸ©å½¢æ¡†å³ä¸‹è§’çš„åæ ‡

(ğ‘¥,ğ‘¦,ğ‘¤,â„)ï¼Œå…¶ä¸­(ğ‘¥,ğ‘¦)****æ˜¯çŸ©å½¢æ¡†ä¸­å¿ƒç‚¹çš„åæ ‡ï¼Œğ‘¤æ˜¯çŸ©å½¢æ¡†çš„å®½åº¦ï¼Œâ„æ˜¯çŸ©å½¢æ¡†çš„é«˜åº¦

åœ¨æ£€æµ‹ä»»åŠ¡ä¸­ï¼Œè®­ç»ƒæ•°æ®é›†çš„æ ‡ç­¾é‡Œä¼šç»™å‡ºç›®æ ‡ç‰©ä½“çœŸå®è¾¹ç•Œæ¡†æ‰€å¯¹åº”çš„(ğ‘¥1,ğ‘¦1,ğ‘¥2,ğ‘¦2)ï¼Œè¿™æ ·çš„è¾¹ç•Œæ¡†ä¹Ÿè¢«ç§°ä¸ºçœŸå®æ¡†ï¼ˆground truth boxï¼‰

## é”šæ¡†ï¼ˆAnchor boxï¼‰

é”šæ¡†ä¸ç‰©ä½“è¾¹ç•Œæ¡†ä¸åŒï¼Œæ˜¯ç”±äººä»¬å‡æƒ³å‡ºæ¥çš„ä¸€ç§æ¡†

```
# ç”»å›¾å±•ç¤ºå¦‚ä½•ç»˜åˆ¶è¾¹ç•Œæ¡†å’Œé”šæ¡†
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.patches as patches
from matplotlib.image import imread
import math

# å®šä¹‰ç”»çŸ©å½¢æ¡†çš„ç¨‹åº  
def draw_rectangle(currentAxis, bbox, edgecolor = 'k', facecolor = 'y', fill=False, linestyle='-'):
    # currentAxisï¼Œåæ ‡è½´ï¼Œé€šè¿‡plt.gca()è·å–
    # bboxï¼Œè¾¹ç•Œæ¡†ï¼ŒåŒ…å«å››ä¸ªæ•°å€¼çš„listï¼Œ [x1, y1, x2, y2]
    # edgecolorï¼Œè¾¹æ¡†çº¿æ¡é¢œè‰²
    # facecolorï¼Œå¡«å……é¢œè‰²
    # fill, æ˜¯å¦å¡«å……
    # linestypeï¼Œè¾¹æ¡†çº¿å‹
    # patches.Rectangleéœ€è¦ä¼ å…¥å·¦ä¸Šè§’åæ ‡ã€çŸ©å½¢åŒºåŸŸçš„å®½åº¦ã€é«˜åº¦ç­‰å‚æ•°
    rect=patches.Rectangle((bbox[0], bbox[1]), bbox[2]-bbox[0]+1, bbox[3]-bbox[1]+1, linewidth=1,
                           edgecolor=edgecolor,facecolor=facecolor,fill=fill, linestyle=linestyle)
    currentAxis.add_patch(rect)

  
plt.figure(figsize=(10, 10))

filename = '/home/aistudio/work/images/section3/000000086956.jpg'
im = imread(filename)
plt.imshow(im)

# ä½¿ç”¨xyxyæ ¼å¼è¡¨ç¤ºç‰©ä½“çœŸå®æ¡†
bbox1 = [214.29, 325.03, 399.82, 631.37]
bbox2 = [40.93, 141.1, 226.99, 515.73]
bbox3 = [247.2, 131.62, 480.0, 639.32]

currentAxis=plt.gca()

draw_rectangle(currentAxis, bbox1, edgecolor='r')
draw_rectangle(currentAxis, bbox2, edgecolor='r')
draw_rectangle(currentAxis, bbox3,edgecolor='r')

# ç»˜åˆ¶é”šæ¡†
def draw_anchor_box(center, length, scales, ratios, img_height, img_width):
    """
    ä»¥centerä¸ºä¸­å¿ƒï¼Œäº§ç”Ÿä¸€ç³»åˆ—é”šæ¡†
    å…¶ä¸­lengthæŒ‡å®šäº†ä¸€ä¸ªåŸºå‡†çš„é•¿åº¦
    scalesæ˜¯åŒ…å«å¤šç§å°ºå¯¸æ¯”ä¾‹çš„list
    ratiosæ˜¯åŒ…å«å¤šç§é•¿å®½æ¯”çš„list
    img_heightå’Œimg_widthæ˜¯å›¾ç‰‡çš„å°ºå¯¸ï¼Œç”Ÿæˆçš„é”šæ¡†èŒƒå›´ä¸èƒ½è¶…å‡ºå›¾ç‰‡å°ºå¯¸ä¹‹å¤–
    """
    bboxes = []
    for scale in scales:
        for ratio in ratios:
            h = length*scale*math.sqrt(ratio)
            w = length*scale/math.sqrt(ratio) 
            x1 = max(center[0] - w/2., 0.)
            y1 = max(center[1] - h/2., 0.)
            x2 = min(center[0] + w/2. - 1.0, img_width - 1.0)
            y2 = min(center[1] + h/2. - 1.0, img_height - 1.0)
            print(center[0], center[1], w, h)
            bboxes.append([x1, y1, x2, y2])

    for bbox in bboxes:
        draw_rectangle(currentAxis, bbox, edgecolor = 'b')

img_height = im.shape[0]
img_width = im.shape[1]  
draw_anchor_box([300., 500.], 100., [2.0], [0.5, 1.0, 2.0], img_height, img_width)


################# ä»¥ä¸‹ä¸ºæ·»åŠ æ–‡å­—è¯´æ˜å’Œç®­å¤´###############################

plt.text(285, 285, 'G1', color='red', fontsize=20)
plt.arrow(300, 288, 30, 40, color='red', width=0.001, length_includes_head=True, \
         head_width=5, head_length=10, shape='full')

plt.text(190, 320, 'A1', color='blue', fontsize=20)
plt.arrow(200, 320, 30, 40, color='blue', width=0.001, length_includes_head=True, \
         head_width=5, head_length=10, shape='full')

plt.text(160, 370, 'A2', color='blue', fontsize=20)
plt.arrow(170, 370, 30, 40, color='blue', width=0.001, length_includes_head=True, \
         head_width=5, head_length=10, shape='full')

plt.text(115, 420, 'A3', color='blue', fontsize=20)
plt.arrow(127, 420, 30, 40, color='blue', width=0.001, length_includes_head=True, \
         head_width=5, head_length=10, shape='full')

#draw_anchor_box([200., 200.], 100., [2.0], [0.5, 1.0, 2.0])  
plt.show()
```

åœ¨ç›®æ ‡æ£€æµ‹ä»»åŠ¡ä¸­ï¼Œé€šå¸¸ä¼šä»¥æŸç§è§„åˆ™åœ¨å›¾ç‰‡ä¸Šç”Ÿæˆä¸€ç³»åˆ—é”šæ¡†ï¼Œå°†è¿™äº›é”šæ¡†å½“æˆå¯èƒ½çš„å€™é€‰åŒºåŸŸã€‚æ¨¡å‹å¯¹è¿™äº›å€™é€‰åŒºåŸŸæ˜¯å¦åŒ…å«ç‰©ä½“è¿›è¡Œé¢„æµ‹ï¼Œå¦‚æœåŒ…å«ç›®æ ‡ç‰©ä½“ï¼Œåˆ™è¿˜éœ€è¦è¿›ä¸€æ­¥é¢„æµ‹å‡ºç‰©ä½“æ‰€å±çš„ç±»åˆ«ã€‚

è¿˜æœ‰æ›´ä¸ºé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äºé”šæ¡†ä½ç½®æ˜¯å›ºå®šçš„ï¼Œå®ƒä¸å¤§å¯èƒ½åˆšå¥½è·Ÿç‰©ä½“è¾¹ç•Œæ¡†é‡åˆï¼Œæ‰€ä»¥éœ€è¦åœ¨é”šæ¡†çš„åŸºç¡€ä¸Šè¿›è¡Œå¾®è°ƒä»¥å½¢æˆèƒ½å‡†ç¡®æè¿°ç‰©ä½“ä½ç½®çš„é¢„æµ‹æ¡†ï¼Œæ¨¡å‹éœ€è¦é¢„æµ‹å‡ºå¾®è°ƒçš„å¹…åº¦ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹é€šè¿‡å­¦ä¹ ä¸æ–­çš„è°ƒæ•´å‚æ•°ï¼Œæœ€ç»ˆèƒ½å­¦ä¼šå¦‚ä½•åˆ¤åˆ«å‡ºé”šæ¡†æ‰€ä»£è¡¨çš„å€™é€‰åŒºåŸŸæ˜¯å¦åŒ…å«ç‰©ä½“ï¼Œå¦‚æœåŒ…å«ç‰©ä½“çš„è¯ï¼Œç‰©ä½“å±äºå“ªä¸ªç±»åˆ«ï¼Œä»¥åŠç‰©ä½“è¾¹ç•Œæ¡†ç›¸å¯¹äºé”šæ¡†ä½ç½®éœ€è¦è°ƒæ•´çš„å¹…åº¦ã€‚

## äº¤å¹¶æ¯”â€”â€”è¡¡é‡æŒ‡æ ‡

äº¤å…µæ¯”è®¡ç®—ç¨‹åº

```
# è®¡ç®—IoUï¼ŒçŸ©å½¢æ¡†çš„åæ ‡å½¢å¼ä¸ºxyxyï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«ä¿å­˜åœ¨box_utils.pyæ–‡ä»¶ä¸­
def box_iou_xyxy(box1, box2):
    # è·å–box1å·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„åæ ‡
    x1min, y1min, x1max, y1max = box1[0], box1[1], box1[2], box1[3]
    # è®¡ç®—box1çš„é¢ç§¯
    s1 = (y1max - y1min + 1.) * (x1max - x1min + 1.)
    # è·å–box2å·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„åæ ‡
    x2min, y2min, x2max, y2max = box2[0], box2[1], box2[2], box2[3]
    # è®¡ç®—box2çš„é¢ç§¯
    s2 = (y2max - y2min + 1.) * (x2max - x2min + 1.)
  
    # è®¡ç®—ç›¸äº¤çŸ©å½¢æ¡†çš„åæ ‡
    xmin = np.maximum(x1min, x2min)
    ymin = np.maximum(y1min, y2min)
    xmax = np.minimum(x1max, x2max)
    ymax = np.minimum(y1max, y2max)
    # è®¡ç®—ç›¸äº¤çŸ©å½¢è¡Œçš„é«˜åº¦ã€å®½åº¦ã€é¢ç§¯
    inter_h = np.maximum(ymax - ymin + 1., 0.)
    inter_w = np.maximum(xmax - xmin + 1., 0.)
    intersection = inter_h * inter_w
    # è®¡ç®—ç›¸å¹¶é¢ç§¯
    union = s1 + s2 - intersection
    # è®¡ç®—äº¤å¹¶æ¯”
    iou = intersection / union
    return iou


bbox1 = [100., 100., 200., 200.]
bbox2 = [120., 120., 220., 220.]
iou = box_iou_xyxy(bbox1, bbox2)
print('IoU is {}'.format(iou))  
```

```
IoU is 0.47402644317607107
```

```
# è®¡ç®—IoUï¼ŒçŸ©å½¢æ¡†çš„åæ ‡å½¢å¼ä¸ºxywh
def box_iou_xywh(box1, box2):
    x1min, y1min = box1[0] - box1[2]/2.0, box1[1] - box1[3]/2.0
    x1max, y1max = box1[0] + box1[2]/2.0, box1[1] + box1[3]/2.0
    s1 = box1[2] * box1[3]

    x2min, y2min = box2[0] - box2[2]/2.0, box2[1] - box2[3]/2.0
    x2max, y2max = box2[0] + box2[2]/2.0, box2[1] + box2[3]/2.0
    s2 = box2[2] * box2[3]

    xmin = np.maximum(x1min, x2min)
    ymin = np.maximum(y1min, y2min)
    xmax = np.minimum(x1max, x2max)
    ymax = np.minimum(y1max, y2max)
    inter_h = np.maximum(ymax - ymin, 0.)
    inter_w = np.maximum(xmax - xmin, 0.)
    intersection = inter_h * inter_w

    union = s1 + s2 - intersection
    iou = intersection / union
    return iou

bbox1 = [100., 100., 200., 200.]
bbox2 = [120., 120., 220., 220.]
iou = box_iou_xywh(bbox1, bbox2)
print('IoU is {}'.format(iou))  
```

```
IoU is 0.6902485659655831
```

# ç›®æ ‡æ£€æµ‹YOLOv3

## æ—ä¸šç—…è™«å®³æ•°æ®é›†å’Œæ•°æ®é¢„å¤„ç†æ–¹æ³•ä»‹ç»

### è¯»å–AIè¯†è™«æ•°æ®é›†æ ‡æ³¨ä¿¡æ¯

AIè¯†è™«æ•°æ®é›†ç»“æ„å¦‚ä¸‹ï¼š

* æä¾›äº†2183å¼ å›¾ç‰‡ï¼Œå…¶ä¸­è®­ç»ƒé›†1693å¼ ï¼ŒéªŒè¯é›†245å¼ ï¼Œæµ‹è¯•é›†245å¼ ã€‚
* åŒ…å«7ç§æ˜†è™«ï¼Œåˆ†åˆ«æ˜¯Boernerã€Leconteã€Linnaeusã€acuminatusã€armandiã€coleopteraå’Œlinnaeusã€‚
* åŒ…å«äº†å›¾ç‰‡å’Œæ ‡æ³¨ï¼Œè¯·è¯»è€…å…ˆå°†æ•°æ®è§£å‹ï¼Œå¹¶å­˜æ”¾åœ¨insectsç›®å½•ä¸‹ã€‚

```
# è§£å‹æ•°æ®è„šæœ¬ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œæ—¶æ‰“å¼€æ³¨é‡Šï¼Œå°†æ–‡ä»¶è§£å‹åˆ°workç›®å½•ä¸‹
!unzip  -o -q -d  /home/aistudio/work /home/aistudio/data/data19638/insects.zip
```

å°†æ•°æ®è§£å‹ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°insectsç›®å½•ä¸‹çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºã€‚

```
    insects
        |---train
        |         |---annotations
        |         |         |---xmls
        |         |                  |---100.xml
        |         |                  |---101.xml
        |         |                  |---...
        |         |
        |         |---images
        |                   |---100.jpeg
        |                   |---101.jpeg
        |                   |---...
        |
        |---val
        |        |---annotations
        |        |         |---xmls
        |        |                  |---1221.xml
        |        |                  |---1277.xml
        |        |                  |---...
        |        |
        |        |---images
        |                  |---1221.jpeg
        |                  |---1277.jpeg
        |                  |---...
        |
        |---test
                 |---images
                           |---1833.jpeg
                           |---1838.jpeg
                           |---...
```

insectsåŒ…å«trainã€valå’Œtestä¸‰ä¸ªæ–‡ä»¶å¤¹ã€‚train/annotations/xmlsç›®å½•ä¸‹å­˜æ”¾ç€å›¾ç‰‡çš„æ ‡æ³¨ã€‚æ¯ä¸ªxmlæ–‡ä»¶æ˜¯å¯¹ä¸€å¼ å›¾ç‰‡çš„è¯´æ˜ï¼ŒåŒ…æ‹¬å›¾ç‰‡å°ºå¯¸ã€åŒ…å«çš„æ˜†è™«åç§°ã€åœ¨å›¾ç‰‡ä¸Šå‡ºç°çš„ä½ç½®ç­‰ä¿¡æ¯ã€‚

* sizeï¼šå›¾ç‰‡å°ºå¯¸ã€‚
* objectï¼šå›¾ç‰‡ä¸­åŒ…å«çš„ç‰©ä½“ï¼Œä¸€å¼ å›¾ç‰‡å¯èƒ½ä¸­åŒ…å«å¤šä¸ªç‰©ä½“ã€‚

â€“ nameï¼šæ˜†è™«åç§°ï¼›

â€“ bndboxï¼šç‰©ä½“çœŸå®æ¡†ï¼›

â€“ difficultï¼šè¯†åˆ«æ˜¯å¦å›°éš¾ã€‚

```
<annotation>
        <folder>åˆ˜éœéœ</folder>
        <filename>100.jpeg</filename>
        <path>/home/fion/æ¡Œé¢/åˆ˜éœéœ/100.jpeg</path>
        <source>
                <database>Unknown</database>
        </source>
        <size>
                <width>1336</width>
                <height>1336</height>
                <depth>3</depth>
        </size>
        <segmented>0</segmented>
        <object>
                <name>Boerner</name>
                <pose>Unspecified</pose>
                <truncated>0</truncated>
                <difficult>0</difficult>
                <bndbox>
                        <xmin>500</xmin>
                        <ymin>893</ymin>
                        <xmax>656</xmax>
                        <ymax>966</ymax>
                </bndbox>
        </object>
        <object>
                <name>Leconte</name>
                <pose>Unspecified</pose>
                <truncated>0</truncated>
                <difficult>0</difficult>
                <bndbox>
                        <xmin>622</xmin>
                        <ymin>490</ymin>
                        <xmax>756</xmax>
                        <ymax>610</ymax>
                </bndbox>
        </object>
        <object>
                <name>armandi</name>
                <pose>Unspecified</pose>
                <truncated>0</truncated>
                <difficult>0</difficult>
                <bndbox>
                        <xmin>432</xmin>
                        <ymin>663</ymin>
                        <xmax>517</xmax>
                        <ymax>729</ymax>
                </bndbox>
        </object>
        <object>
                <name>coleoptera</name>
                <pose>Unspecified</pose>
                <truncated>0</truncated>
                <difficult>0</difficult>
                <bndbox>
                        <xmin>624</xmin>
                        <ymin>685</ymin>
                        <xmax>697</xmax>
                        <ymax>771</ymax>
                </bndbox>
        </object>
        <object>
                <name>linnaeus</name>
                <pose>Unspecified</pose>
                <truncated>0</truncated>
                <difficult>0</difficult>
                <bndbox>
                        <xmin>783</xmin>
                        <ymin>700</ymin>
                        <xmax>856</xmax>
                        <ymax>802</ymax>
                </bndbox>
        </object>
</annotation>
```

ä¸‹é¢æˆ‘ä»¬å°†ä»æ•°æ®é›†ä¸­è¯»å–xmlæ–‡ä»¶ï¼Œå°†æ¯å¼ å›¾ç‰‡çš„æ ‡æ³¨ä¿¡æ¯è¯»å–å‡ºæ¥ã€‚åœ¨è¯»å–å…·ä½“çš„æ ‡æ³¨æ–‡ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå®Œæˆä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å°†æ˜†è™«çš„ç±»åˆ«åå­—ï¼ˆå­—ç¬¦ä¸²ï¼‰è½¬åŒ–æˆæ•°å­—è¡¨ç¤ºçš„ç±»åˆ«ã€‚å› ä¸ºç¥ç»ç½‘ç»œé‡Œé¢è®¡ç®—æ—¶éœ€è¦çš„è¾“å…¥ç±»å‹æ˜¯æ•°å€¼å‹çš„ï¼Œæ‰€ä»¥éœ€è¦å°†å­—ç¬¦ä¸²è¡¨ç¤ºçš„ç±»åˆ«è½¬åŒ–æˆå…·ä½“çš„æ•°å­—ã€‚æ˜†è™«ç±»åˆ«åç§°çš„åˆ—è¡¨æ˜¯ï¼š[â€˜Boernerâ€™, â€˜Leconteâ€™, â€˜Linnaeusâ€™, â€˜acuminatusâ€™, â€˜armandiâ€™, â€˜coleopteraâ€™, â€˜linnaeusâ€™]ï¼Œè¿™é‡Œæˆ‘ä»¬çº¦å®šæ­¤åˆ—è¡¨ä¸­ï¼š'Boernerâ€™å¯¹åº”ç±»åˆ«0ï¼Œ'Leconteâ€™å¯¹åº”ç±»åˆ«1ï¼Œâ€¦ï¼Œ'linnaeusâ€™å¯¹åº”ç±»åˆ«6

```
INSECT_NAMES = ['Boerner', 'Leconte', 'Linnaeus', 
                'acuminatus', 'armandi', 'coleoptera', 'linnaeus']

def get_insect_names():
    """
    return a dict, as following,
        {'Boerner': 0,
         'Leconte': 1,
         'Linnaeus': 2, 
         'acuminatus': 3,
         'armandi': 4,
         'coleoptera': 5,
         'linnaeus': 6
        }
    It can map the insect name into an integer label.
    """
    insect_category2id = {}
    for i, item in enumerate(INSECT_NAMES):
        insect_category2id[item] = i

    return insect_category2id
```

```
cname2cid = get_insect_names()
cname2cid
```

```
{'Boerner': 0,Â 'Leconte': 1,Â 'Linnaeus': 2,Â 'acuminatus': 3,Â 'armandi': 4,Â 'coleoptera': 5,Â 'linnaeus': 6}
```

è°ƒç”¨get_insect_nameså‡½æ•°è¿”å›ä¸€ä¸ªdictï¼Œæè¿°äº†æ˜†è™«åç§°å’Œæ•°å­—ç±»åˆ«ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚ä¸‹é¢çš„ç¨‹åºä»annotations/xmlç›®å½•ä¸‹é¢è¯»å–æ‰€æœ‰æ–‡ä»¶æ ‡æ³¨ä¿¡æ¯ã€‚

```
import os
import numpy as np
import xml.etree.ElementTree as ET

def get_annotations(cname2cid, datadir):
    filenames = os.listdir(os.path.join(datadir, 'annotations', 'xmls'))
    records = []
    ct = 0
    for fname in filenames:
        fid = fname.split('.')[0]
        fpath = os.path.join(datadir, 'annotations', 'xmls', fname)
        img_file = os.path.join(datadir, 'images', fid + '.jpeg')
        tree = ET.parse(fpath)

        if tree.find('id') is None:
            im_id = np.array([ct])
        else:
            im_id = np.array([int(tree.find('id').text)])

        objs = tree.findall('object')
        im_w = float(tree.find('size').find('width').text)
        im_h = float(tree.find('size').find('height').text)
        gt_bbox = np.zeros((len(objs), 4), dtype=np.float32)
        gt_class = np.zeros((len(objs), ), dtype=np.int32)
        is_crowd = np.zeros((len(objs), ), dtype=np.int32)
        difficult = np.zeros((len(objs), ), dtype=np.int32)
        for i, obj in enumerate(objs):
            cname = obj.find('name').text
            gt_class[i] = cname2cid[cname]
            _difficult = int(obj.find('difficult').text)
            x1 = float(obj.find('bndbox').find('xmin').text)
            y1 = float(obj.find('bndbox').find('ymin').text)
            x2 = float(obj.find('bndbox').find('xmax').text)
            y2 = float(obj.find('bndbox').find('ymax').text)
            x1 = max(0, x1)
            y1 = max(0, y1)
            x2 = min(im_w - 1, x2)
            y2 = min(im_h - 1, y2)
            # è¿™é‡Œä½¿ç”¨xywhæ ¼å¼æ¥è¡¨ç¤ºç›®æ ‡ç‰©ä½“çœŸå®æ¡†
            gt_bbox[i] = [(x1+x2)/2.0 , (y1+y2)/2.0, x2-x1+1., y2-y1+1.]
            is_crowd[i] = 0
            difficult[i] = _difficult

        voc_rec = {
            'im_file': img_file,
            'im_id': im_id,
            'h': im_h,
            'w': im_w,
            'is_crowd': is_crowd,
            'gt_class': gt_class,
            'gt_bbox': gt_bbox,
            'gt_poly': [],
            'difficult': difficult
            }
        if len(objs) != 0:
            records.append(voc_rec)
        ct += 1
    return records
```

```
TRAINDIR = '/home/aistudio/work/insects/train'
TESTDIR = '/home/aistudio/work/insects/test'
VALIDDIR = '/home/aistudio/work/insects/val'
cname2cid = get_insect_names()
records = get_annotations(cname2cid, TRAINDIR)
```

```
len(records)
```

```
1693
```

```
records[0]
```

### æ•°æ®è¯»å–å’Œé¢„å¤„ç†

æ•°æ®é¢„å¤„ç†æ˜¯è®­ç»ƒç¥ç»ç½‘ç»œæ—¶éå¸¸é‡è¦çš„æ­¥éª¤ã€‚åˆé€‚çš„é¢„å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©æ¨¡å‹æ›´å¥½çš„æ”¶æ•›å¹¶é˜²æ­¢è¿‡æ‹Ÿåˆã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦ä»ç£ç›˜è¯»å…¥æ•°æ®ï¼Œç„¶åéœ€è¦å¯¹è¿™äº›æ•°æ®è¿›è¡Œé¢„å¤„ç†ï¼Œä¸ºäº†ä¿è¯ç½‘ç»œè¿è¡Œçš„é€Ÿåº¦ï¼Œé€šå¸¸è¿˜è¦å¯¹æ•°æ®é¢„å¤„ç†è¿›è¡ŒåŠ é€Ÿã€‚

#### æ•°æ®è¯»å–

å‰é¢å·²ç»å°†å›¾ç‰‡çš„æ‰€æœ‰æè¿°ä¿¡æ¯ä¿å­˜åœ¨recordsä¸­äº†ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½åŒ…å«äº†ä¸€å¼ å›¾ç‰‡çš„æè¿°ï¼Œä¸‹é¢çš„ç¨‹åºå±•ç¤ºäº†å¦‚ä½•æ ¹æ®recordsé‡Œé¢çš„æè¿°è¯»å–å›¾ç‰‡åŠæ ‡æ³¨ã€‚

```
# æ•°æ®è¯»å–
import cv2

def get_bbox(gt_bbox, gt_class):
    # å¯¹äºä¸€èˆ¬çš„æ£€æµ‹ä»»åŠ¡æ¥è¯´ï¼Œä¸€å¼ å›¾ç‰‡ä¸Šå¾€å¾€ä¼šæœ‰å¤šä¸ªç›®æ ‡ç‰©ä½“
    # è®¾ç½®å‚æ•°MAX_NUM = 50ï¼Œ å³ä¸€å¼ å›¾ç‰‡æœ€å¤šå–50ä¸ªçœŸå®æ¡†ï¼›å¦‚æœçœŸå®
    # æ¡†çš„æ•°ç›®å°‘äº50ä¸ªï¼Œåˆ™å°†ä¸è¶³éƒ¨åˆ†çš„gt_bbox, gt_classå’Œgt_scoreçš„å„é¡¹æ•°å€¼å…¨è®¾ç½®ä¸º0
    MAX_NUM = 50
    gt_bbox2 = np.zeros((MAX_NUM, 4))
    gt_class2 = np.zeros((MAX_NUM,))
    for i in range(len(gt_bbox)):
        gt_bbox2[i, :] = gt_bbox[i, :]
        gt_class2[i] = gt_class[i]
        if i >= MAX_NUM:
            break
    return gt_bbox2, gt_class2

def get_img_data_from_file(record):
    """
    record is a dict as following,
      record = {
            'im_file': img_file,
            'im_id': im_id,
            'h': im_h,
            'w': im_w,
            'is_crowd': is_crowd,
            'gt_class': gt_class,
            'gt_bbox': gt_bbox,
            'gt_poly': [],
            'difficult': difficult
            }
    """
    im_file = record['im_file']
    h = record['h']
    w = record['w']
    is_crowd = record['is_crowd']
    gt_class = record['gt_class']
    gt_bbox = record['gt_bbox']
    difficult = record['difficult']

    img = cv2.imread(im_file)
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
			#cv2.cvtColoræ˜¯OpenCVåº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå°†å›¾åƒä»ä¸€ç§é¢œè‰²ç©ºé—´è½¬æ¢ä¸ºå¦ä¸€ç§é¢œè‰²ç©ºé—´ã€‚

    # check if h and w in record equals that read from img
    assert img.shape[0] == int(h), \
             "image height of {} inconsistent in record({}) and img file({})".format(
               im_file, h, img.shape[0])

    assert img.shape[1] == int(w), \
             "image width of {} inconsistent in record({}) and img file({})".format(
               im_file, w, img.shape[1])

    gt_boxes, gt_labels = get_bbox(gt_bbox, gt_class)

    # gt_bbox ç”¨ç›¸å¯¹å€¼
    gt_boxes[:, 0] = gt_boxes[:, 0] / float(w)
    gt_boxes[:, 1] = gt_boxes[:, 1] / float(h)
    gt_boxes[:, 2] = gt_boxes[:, 2] / float(w)
    gt_boxes[:, 3] = gt_boxes[:, 3] / float(h)
  
    return img, gt_boxes, gt_labels, (h, w)
```

`get_img_data_from_file()`å‡½æ•°å¯ä»¥è¿”å›å›¾ç‰‡æ•°æ®çš„æ•°æ®ï¼Œå®ƒä»¬æ˜¯å›¾åƒæ•°æ®imgï¼ŒçœŸå®æ¡†åæ ‡gt_boxesï¼ŒçœŸå®æ¡†åŒ…å«çš„ç‰©ä½“ç±»åˆ«gt_labelsï¼Œå›¾åƒå°ºå¯¸scalesã€‚

#### æ•°æ®é¢„å¤„ç†

åœ¨è®¡ç®—æœºè§†è§‰ä¸­ï¼Œé€šå¸¸ä¼šå¯¹å›¾åƒåšä¸€äº›éšæœºçš„å˜åŒ–ï¼Œäº§ç”Ÿç›¸ä¼¼ä½†åˆä¸å®Œå…¨ç›¸åŒçš„æ ·æœ¬ã€‚ä¸»è¦ä½œç”¨æ˜¯æ‰©å¤§è®­ç»ƒæ•°æ®é›†ï¼ŒæŠ‘åˆ¶è¿‡æ‹Ÿåˆï¼Œæå‡æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œå¸¸ç”¨çš„æ–¹æ³•ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š

* éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²
* éšæœºå¡«å……
* éšæœºè£å‰ª
* éšæœºç¼©æ”¾
* éšæœºç¿»è½¬
* éšæœºæ‰“ä¹±çœŸå®æ¡†æ’åˆ—é¡ºåº

numpy å®ç°è¿™äº›æ•°æ®å¢å¼ºæ–¹æ³•

#### **éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰**

```
import numpy as np
import cv2
from PIL import Image, ImageEnhance  
# ImageEnhancæ¨¡å—æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥å¢å¼ºå›¾åƒçš„ç‰¹å®šå±æ€§ï¼Œå¦‚äº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦å’Œé”åº¦ç­‰
import random

# éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰
def random_distort(img):
    # éšæœºæ”¹å˜äº®åº¦
    def random_brightness(img, lower=0.5, upper=1.5):
        e = np.random.uniform(lower, upper)
        return ImageEnhance.Brightness(img).enhance(e)
    # éšæœºæ”¹å˜å¯¹æ¯”åº¦
    def random_contrast(img, lower=0.5, upper=1.5):
        e = np.random.uniform(lower, upper)
        return ImageEnhance.Contrast(img).enhance(e)
    # éšæœºæ”¹å˜é¢œè‰²
    def random_color(img, lower=0.5, upper=1.5):
        e = np.random.uniform(lower, upper)
        return ImageEnhance.Color(img).enhance(e)

    ops = [random_brightness, random_contrast, random_color]
    np.random.shuffle(ops)

    img = Image.fromarray(img)
    img = ops[0](img)
    img = ops[1](img)
    img = ops[2](img)
    img = np.asarray(img)

    return img

# å®šä¹‰å¯è§†åŒ–å‡½æ•°ï¼Œç”¨äºå¯¹æ¯”åŸå›¾å’Œå›¾åƒå¢å¼ºçš„æ•ˆæœ
import matplotlib.pyplot as plt
def visualize(srcimg, img_enhance):
    # å›¾åƒå¯è§†åŒ–
    plt.figure(num=2, figsize=(6,12))
    plt.subplot(1,2,1)
    plt.title('Src Image', color='#0000FF')
    plt.axis('off') # ä¸æ˜¾ç¤ºåæ ‡è½´
    plt.imshow(srcimg) # æ˜¾ç¤ºåŸå›¾ç‰‡

    # å¯¹åŸå›¾åš éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰ æ•°æ®å¢å¼º
    srcimg_gtbox = records[0]['gt_bbox']
    srcimg_label = records[0]['gt_class']

    plt.subplot(1,2,2)
    plt.title('Enhance Image', color='#0000FF')
    plt.axis('off') # ä¸æ˜¾ç¤ºåæ ‡è½´
    plt.imshow(img_enhance)



image_path = records[0]['im_file']
print("read image from file {}".format(image_path))
srcimg = Image.open(image_path)
# å°†PILè¯»å–çš„å›¾åƒè½¬æ¢æˆarrayç±»å‹
srcimg = np.array(srcimg)

# å¯¹åŸå›¾åš éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰ æ•°æ®å¢å¼º
img_enhance = random_distort(srcimg)
visualize(srcimg, img_enhance)
```

```
read image from file /home/aistudio/work/insects/train/images/1123.jpeg
```

#### **éšæœºå¡«å……**

```
def random_expand(img,
                  gtboxes,
                  max_ratio=4.,
                  fill=None,
                  keep_ratio=True,
                  thresh=0.5):
    if random.random() > thresh:
        return img, gtboxes

    if max_ratio < 1.0:
        return img, gtboxes

    h, w, c = img.shape
    ratio_x = random.uniform(1, max_ratio)
    if keep_ratio:
        ratio_y = ratio_x
    else:
        ratio_y = random.uniform(1, max_ratio)
    oh = int(h * ratio_y)
    ow = int(w * ratio_x)
    off_x = random.randint(0, ow - w)
    off_y = random.randint(0, oh - h)

    out_img = np.zeros((oh, ow, c))
    if fill and len(fill) == c:
        for i in range(c):
            out_img[:, :, i] = fill[i] * 255.0

    out_img[off_y:off_y + h, off_x:off_x + w, :] = img
    gtboxes[:, 0] = ((gtboxes[:, 0] * w) + off_x) / float(ow)
    gtboxes[:, 1] = ((gtboxes[:, 1] * h) + off_y) / float(oh)
    gtboxes[:, 2] = gtboxes[:, 2] / ratio_x
    gtboxes[:, 3] = gtboxes[:, 3] / ratio_y

    return out_img.astype('uint8'), gtboxes


# å¯¹åŸå›¾åš éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰ æ•°æ®å¢å¼º
srcimg_gtbox = records[0]['gt_bbox']
img_enhance, new_gtbox = random_expand(srcimg, srcimg_gtbox)
visualize(srcimg, img_enhance)
```

#### **éšæœºè£å‰ª**

éšæœºè£å‰ªä¹‹å‰éœ€è¦å…ˆå®šä¹‰ä¸¤ä¸ªå‡½æ•°ï¼Œ`multi_box_iou_xywh`å’Œ `box_crop`è¿™ä¸¤ä¸ªå‡½æ•°å°†è¢«ä¿å­˜åœ¨box_utils.pyæ–‡ä»¶ä¸­

`multi_box_iou_xywh` å‡½æ•°ç”¨äºè®¡ç®—å¤šä¸ªè¾¹ç•Œæ¡†ä¹‹é—´çš„äº¤å¹¶æ¯”ï¼ˆIntersection over Unionï¼ŒIoUï¼‰ã€‚è¾“å…¥å‚æ•° `box1` å’Œ `box2` åˆ†åˆ«è¡¨ç¤ºä¸¤ç»„è¾¹ç•Œæ¡†ï¼Œæ¯ä¸ªè¾¹ç•Œæ¡†ç”±å››ä¸ªå€¼è¡¨ç¤ºï¼šå·¦ä¸Šè§’ x åæ ‡ã€å·¦ä¸Šè§’ y åæ ‡ã€å®½åº¦å’Œé«˜åº¦ã€‚å‡½æ•°è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ è¡¨ç¤ºå¯¹åº”è¾¹ç•Œæ¡†çš„ IoU å€¼ã€‚

`box_crop` å‡½æ•°ç”¨äºå¯¹å›¾åƒè¿›è¡Œè£å‰ªï¼Œå¹¶å¯¹è£å‰ªåçš„è¾¹ç•Œæ¡†è¿›è¡Œè°ƒæ•´ã€‚è¾“å…¥å‚æ•° `boxes` æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ¯è¡Œè¡¨ç¤ºä¸€ä¸ªè¾¹ç•Œæ¡†ï¼Œæ¯ä¸ªè¾¹ç•Œæ¡†ç”±å››ä¸ªå€¼è¡¨ç¤ºï¼šå·¦ä¸Šè§’ x åæ ‡ã€å·¦ä¸Šè§’ y åæ ‡ã€å®½åº¦å’Œé«˜åº¦ã€‚`labels` æ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œè¡¨ç¤ºæ¯ä¸ªè¾¹ç•Œæ¡†å¯¹åº”çš„æ ‡ç­¾ã€‚`crop` æ˜¯ä¸€ä¸ªåŒ…å«å››ä¸ªå€¼çš„å…ƒç»„ï¼Œè¡¨ç¤ºè£å‰ªåŒºåŸŸçš„å·¦ä¸Šè§’ x åæ ‡ã€å·¦ä¸Šè§’ y åæ ‡ã€å®½åº¦å’Œé«˜åº¦ã€‚`img_shape` æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå€¼çš„å…ƒç»„ï¼Œè¡¨ç¤ºåŸå§‹å›¾åƒçš„å®½åº¦å’Œé«˜åº¦ã€‚å‡½æ•°è¿”å›ä¸‰ä¸ªå€¼ï¼šè°ƒæ•´åçš„è¾¹ç•Œæ¡†æ•°ç»„ã€è°ƒæ•´åçš„æ ‡ç­¾æ•°ç»„å’Œè£å‰ªåçš„æœ‰æ•ˆè¾¹ç•Œæ¡†æ•°é‡ã€‚

```
import numpy as np

def multi_box_iou_xywh(box1, box2):
    """
    In this case, box1 or box2 can contain multi boxes.
    Only two cases can be processed in this method:
       1, box1 and box2 have the same shape, box1.shape == box2.shape
       2, either box1 or box2 contains only one box, len(box1) == 1 or len(box2) == 1
    If the shape of box1 and box2 does not match, and both of them contain multi boxes, it will be wrong.
    """
    assert box1.shape[-1] == 4, "Box1 shape[-1] should be 4."
    assert box2.shape[-1] == 4, "Box2 shape[-1] should be 4."


    b1_x1, b1_x2 = box1[:, 0] - box1[:, 2] / 2, box1[:, 0] + box1[:, 2] / 2
    b1_y1, b1_y2 = box1[:, 1] - box1[:, 3] / 2, box1[:, 1] + box1[:, 3] / 2
    b2_x1, b2_x2 = box2[:, 0] - box2[:, 2] / 2, box2[:, 0] + box2[:, 2] / 2
    b2_y1, b2_y2 = box2[:, 1] - box2[:, 3] / 2, box2[:, 1] + box2[:, 3] / 2

    inter_x1 = np.maximum(b1_x1, b2_x1)
    inter_x2 = np.minimum(b1_x2, b2_x2)
    inter_y1 = np.maximum(b1_y1, b2_y1)
    inter_y2 = np.minimum(b1_y2, b2_y2)
    inter_w = inter_x2 - inter_x1
    inter_h = inter_y2 - inter_y1
    inter_w = np.clip(inter_w, a_min=0., a_max=None)
    inter_h = np.clip(inter_h, a_min=0., a_max=None)

    inter_area = inter_w * inter_h
    b1_area = (b1_x2 - b1_x1) * (b1_y2 - b1_y1)
    b2_area = (b2_x2 - b2_x1) * (b2_y2 - b2_y1)

    return inter_area / (b1_area + b2_area - inter_area)

def box_crop(boxes, labels, crop, img_shape):
    x, y, w, h = map(float, crop)
    im_w, im_h = map(float, img_shape)

    boxes = boxes.copy()
    boxes[:, 0], boxes[:, 2] = (boxes[:, 0] - boxes[:, 2] / 2) * im_w, (
        boxes[:, 0] + boxes[:, 2] / 2) * im_w
    boxes[:, 1], boxes[:, 3] = (boxes[:, 1] - boxes[:, 3] / 2) * im_h, (
        boxes[:, 1] + boxes[:, 3] / 2) * im_h

    crop_box = np.array([x, y, x + w, y + h])
    centers = (boxes[:, :2] + boxes[:, 2:]) / 2.0
    mask = np.logical_and(crop_box[:2] <= centers, centers <= crop_box[2:]).all(
        axis=1)

    boxes[:, :2] = np.maximum(boxes[:, :2], crop_box[:2])
    boxes[:, 2:] = np.minimum(boxes[:, 2:], crop_box[2:])
    boxes[:, :2] -= crop_box[:2]
    boxes[:, 2:] -= crop_box[:2]

    mask = np.logical_and(mask, (boxes[:, :2] < boxes[:, 2:]).all(axis=1))
    boxes = boxes * np.expand_dims(mask.astype('float32'), axis=1)
    labels = labels * mask.astype('float32')
    boxes[:, 0], boxes[:, 2] = (boxes[:, 0] + boxes[:, 2]) / 2 / w, (
        boxes[:, 2] - boxes[:, 0]) / w
    boxes[:, 1], boxes[:, 3] = (boxes[:, 1] + boxes[:, 3]) / 2 / h, (
        boxes[:, 3] - boxes[:, 1]) / h

    return boxes, labels, mask.sum()
```

```
# éšæœºè£å‰ª
def random_crop(img,
                boxes,
                labels,
                scales=[0.3, 1.0],
                max_ratio=2.0,
                constraints=None,
                max_trial=50):
    if len(boxes) == 0:
        return img, boxes

    if not constraints:
        constraints = [(0.1, 1.0), (0.3, 1.0), (0.5, 1.0), (0.7, 1.0),
                       (0.9, 1.0), (0.0, 1.0)]

    img = Image.fromarray(img)
    w, h = img.size
    crops = [(0, 0, w, h)]
    for min_iou, max_iou in constraints:
        for _ in range(max_trial):
            scale = random.uniform(scales[0], scales[1])
            aspect_ratio = random.uniform(max(1 / max_ratio, scale * scale), \
                                          min(max_ratio, 1 / scale / scale))
            crop_h = int(h * scale / np.sqrt(aspect_ratio))
            crop_w = int(w * scale * np.sqrt(aspect_ratio))
            crop_x = random.randrange(w - crop_w)
            crop_y = random.randrange(h - crop_h)
            crop_box = np.array([[(crop_x + crop_w / 2.0) / w,
                                  (crop_y + crop_h / 2.0) / h,
                                  crop_w / float(w), crop_h / float(h)]])

            iou = multi_box_iou_xywh(crop_box, boxes)
            if min_iou <= iou.min() and max_iou >= iou.max():
                crops.append((crop_x, crop_y, crop_w, crop_h))
                break

    while crops:
        crop = crops.pop(np.random.randint(0, len(crops)))
        crop_boxes, crop_labels, box_num = box_crop(boxes, labels, crop, (w, h))
        if box_num < 1:
            continue
        img = img.crop((crop[0], crop[1], crop[0] + crop[2],
                        crop[1] + crop[3])).resize(img.size, Image.LANCZOS)
        img = np.asarray(img)
        return img, crop_boxes, crop_labels
    img = np.asarray(img)
    return img, boxes, labels


# å¯¹åŸå›¾åš éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰ æ•°æ®å¢å¼º
srcimg_gtbox = records[0]['gt_bbox']
srcimg_label = records[0]['gt_class']

img_enhance, new_labels, mask = random_crop(srcimg, srcimg_gtbox, srcimg_label)
visualize(srcimg, img_enhance)
```

#### **éšæœºç¼©æ”¾**

```
# éšæœºç¼©æ”¾
def random_interp(img, size, interp=None):
    interp_method = [
        cv2.INTER_NEAREST,
        cv2.INTER_LINEAR,
        cv2.INTER_AREA,
        cv2.INTER_CUBIC,
        cv2.INTER_LANCZOS4,
    ]
    if not interp or interp not in interp_method:
        interp = interp_method[random.randint(0, len(interp_method) - 1)]
    h, w, _ = img.shape
    im_scale_x = size / float(w)
    im_scale_y = size / float(h)
    img = cv2.resize(
        img, None, None, fx=im_scale_x, fy=im_scale_y, interpolation=interp)
    return img

# å¯¹åŸå›¾åš éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰ æ•°æ®å¢å¼º
img_enhance = random_interp(srcimg, 640)
visualize(srcimg, img_enhance)
```

#### **éšæœºç¿»è½¬**

```
# éšæœºç¿»è½¬
def random_flip(img, gtboxes, thresh=0.5):
    if random.random() > thresh:
        img = img[:, ::-1, :]
        gtboxes[:, 0] = 1.0 - gtboxes[:, 0]
    return img, gtboxes


# å¯¹åŸå›¾åš éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰ æ•°æ®å¢å¼º
img_enhance, box_enhance = random_flip(srcimg, srcimg_gtbox)
visualize(srcimg, img_enhance)
```

#### **éšæœºæ‰“ä¹±çœŸå®æ¡†æ’åˆ—é¡ºåº**

```
# éšæœºæ‰“ä¹±çœŸå®æ¡†æ’åˆ—é¡ºåº
def shuffle_gtbox(gtbox, gtlabel):
    gt = np.concatenate(
        [gtbox, gtlabel[:, np.newaxis]], axis=1)
    idx = np.arange(gt.shape[0])
    np.random.shuffle(idx)
    gt = gt[idx, :]
    return gt[:, :4], gt[:, 4]
```

#### **å›¾åƒå¢å¹¿æ–¹æ³•æ±‡æ€»**

```
# å›¾åƒå¢å¹¿æ–¹æ³•æ±‡æ€»
def image_augment(img, gtboxes, gtlabels, size, means=None):
    # éšæœºæ”¹å˜äº®æš—ã€å¯¹æ¯”åº¦å’Œé¢œè‰²ç­‰
    img = random_distort(img)
    # éšæœºå¡«å……
    img, gtboxes = random_expand(img, gtboxes, fill=means)
    # éšæœºè£å‰ª
    img, gtboxes, gtlabels, = random_crop(img, gtboxes, gtlabels)
    # éšæœºç¼©æ”¾
    img = random_interp(img, size)
    # éšæœºç¿»è½¬
    img, gtboxes = random_flip(img, gtboxes)
    # éšæœºæ‰“ä¹±çœŸå®æ¡†æ’åˆ—é¡ºåº
    gtboxes, gtlabels = shuffle_gtbox(gtboxes, gtlabels)

    return img.astype('float32'), gtboxes.astype('float32'), gtlabels.astype('int32')

img_enhance, img_box, img_label = image_augment(srcimg, srcimg_gtbox, srcimg_label, size=320)
visualize(srcimg, img_enhance)
```

### ä½¿ç”¨é£æ¡¨é«˜å±‚APIå¿«é€Ÿå®ç°æ•°æ®å¢å¼º

æˆ‘ä»¬ä½¿ç”¨numpyå®ç°äº†å¤šç§æ•°æ®å¢å¼ºæ–¹å¼ã€‚åŒæ—¶é£æ¡¨ä¹Ÿæä¾›äº†**æ‹¿æ¥å³ç”¨**çš„æ•°æ®å¢å¼ºæ–¹æ³•

[paddle.vision.transforms](https://www.paddlepaddle.org.cn/documentation/docs/zh/2.0-rc1/api/paddle/vision/ops/yolo_box_cn.html)  æ¨¡å— ï¼Œtransformsæ¨¡å—ä¸­æä¾›äº†æ•°åç§æ•°æ®å¢å¼ºæ–¹å¼ï¼ŒåŒ…æ‹¬äº®åº¦å¢å¼º([adjust_brightness](https://www.paddlepaddle.org.cn/documentation/docs/zh/2.0-rc1/api/paddle/vision/transforms/functional/adjust_brightness_cn.html))ï¼Œå¯¹æ¯”åº¦å¢å¼º([adjust_contrast](https://www.paddlepaddle.org.cn/documentation/docs/zh/2.0-rc1/api/paddle/vision/transforms/functional/adjust_contrast.html))ï¼Œéšæœºè£å‰ª([RandomCrop](https://www.paddlepaddle.org.cn/documentation/docs/zh/2.0-rc1/api/paddle/vision/transforms/transforms/RandomCrop_cn.html))ç­‰ç­‰

#### paddle.vision.transformsæ¨¡å—ä¸­çš„æ•°æ®å¢å¼º

```
#å¯¹å›¾åƒéšæœºè£å‰ª
# ä»paddle.vision.transformsæ¨¡å—ä¸­importéšæœºå‰ªåˆ‡çš„API RandomCrop
from paddle.vision.transforms import RandomCrop

# RandomCropæ˜¯ä¸€ä¸ªpythonç±»ï¼Œéœ€è¦äº‹å…ˆå£°æ˜
#RandomCropè¿˜éœ€è¦ä¼ å…¥å‰ªåˆ‡çš„å½¢çŠ¶ï¼Œè¿™é‡Œè®¾ç½®ä¸º640
transform = RandomCrop(640)
# å°†å›¾åƒè½¬æ¢ä¸ºPIL.Imageæ ¼å¼
srcimg = Image.fromarray(np.array(srcimg))
# è°ƒç”¨å£°æ˜å¥½çš„APIå®ç°éšæœºå‰ªåˆ‡
img_res = transform(srcimg)
# å¯è§†åŒ–ç»“æœ
visualize(srcimg, np.array(img_res))
```

#### ç”¨é£æ¡¨é«˜å±‚APIå®ç°äº®åº¦å¢å¼º

```
from paddle.vision.transforms import BrightnessTransform

# BrightnessTransformæ˜¯ä¸€ä¸ªpythonç±»ï¼Œéœ€è¦äº‹å…ˆå£°æ˜
transform = BrightnessTransform(0.4)
# å°†å›¾åƒè½¬æ¢ä¸ºPIL.Imageæ ¼å¼
srcimg = Image.fromarray(np.array(srcimg))
# è°ƒç”¨å£°æ˜å¥½çš„APIå®ç°éšæœºå‰ªåˆ‡
img_res = transform(srcimg)
# å¯è§†åŒ–ç»“æœ
visualize(srcimg, np.array(img_res))
```

### æ‰¹é‡æ•°æ®è¯»å–ä¸åŠ é€Ÿ

```
# è·å–ä¸€ä¸ªæ‰¹æ¬¡å†…æ ·æœ¬éšæœºç¼©æ”¾çš„å°ºå¯¸
def get_img_size(mode):
    if (mode == 'train') or (mode == 'valid'):
        inds = np.array([0,1,2,3,4,5,6,7,8,9])
        ii = np.random.choice(inds)
        img_size = 320 + ii * 32
    else:
        img_size = 608
    return img_size

# å°† listå½¢å¼çš„batchæ•°æ® è½¬åŒ–æˆå¤šä¸ªarrayæ„æˆçš„tuple
def make_array(batch_data):
    img_array = np.array([item[0] for item in batch_data], dtype = 'float32')
    gt_box_array = np.array([item[1] for item in batch_data], dtype = 'float32')
    gt_labels_array = np.array([item[2] for item in batch_data], dtype = 'int32')
    img_scale = np.array([item[3] for item in batch_data], dtype='int32')
    return img_array, gt_box_array, gt_labels_array, img_scale
```

ã€‚é€šè¿‡ä½¿ç”¨é£æ¡¨æä¾›çš„[paddle.io.DataLoader](https://www.paddlepaddle.org.cn/documentation/docs/en/develop/api/paddle/io/DataLoader_en.html) APIä¸­çš„num_workerså‚æ•°è®¾ç½®è¿›ç¨‹æ•°é‡ï¼Œå®ç°å¤šè¿›ç¨‹è¯»å–æ•°æ®

```
import paddle

# å®šä¹‰æ•°æ®è¯»å–ç±»ï¼Œç»§æ‰¿Paddle.io.Dataset
class TrainDataset(paddle.io.Dataset):
    def  __init__(self, datadir, mode='train'):
        self.datadir = datadir
        cname2cid = get_insect_names()
        self.records = get_annotations(cname2cid, datadir)
        self.img_size = 640  #get_img_size(mode)

    def __getitem__(self, idx):
        record = self.records[idx]
        # print("print: ", record)
        img, gt_bbox, gt_labels, im_shape = get_img_data(record, size=self.img_size)

        return img, gt_bbox, gt_labels, np.array(im_shape)

    def __len__(self):
        return len(self.records)

# åˆ›å»ºæ•°æ®è¯»å–ç±»
train_dataset = TrainDataset(TRAINDIR, mode='train')

# ä½¿ç”¨paddle.io.DataLoaderåˆ›å»ºæ•°æ®è¯»å–å™¨ï¼Œå¹¶è®¾ç½®batchsizeï¼Œè¿›ç¨‹æ•°é‡num_workersç­‰å‚æ•°
train_loader = paddle.io.DataLoader(train_dataset, batch_size=2, shuffle=True, num_workers=2, drop_last=True)
```

```
d = paddle.io.DataLoader(train_dataset, batch_size=2, shuffle=True, num_workers=1, drop_last=True)
```

```
img, gt_boxes, gt_labels, im_shape = next(d())
```

```
img.shape, gt_boxes.shape, gt_labels.shape, im_shape.shape
```

```
([2, 3, 640, 640], [2, 50, 4], [2, 50], [2, 2])
```

æˆ‘ä»¬å®Œæˆäº†å¦‚ä½•æŸ¥çœ‹æ•°æ®é›†ä¸­çš„æ•°æ®ã€æå–æ•°æ®æ ‡æ³¨ä¿¡æ¯ã€ä»æ–‡ä»¶è¯»å–å›¾åƒå’Œæ ‡æ³¨æ•°æ®ã€å›¾åƒå¢å¹¿ã€æ‰¹é‡è¯»å–å’ŒåŠ é€Ÿç­‰è¿‡ç¨‹ï¼Œé€šè¿‡ `paddle.io.Dataset`å¯ä»¥è¿”å›img, gt_boxes, gt_labels, im_shapeç­‰æ•°æ®ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å°†å®ƒä»¬è¾“å…¥åˆ°ç¥ç»ç½‘ç»œï¼Œåº”ç”¨åˆ°å…·ä½“ç®—æ³•ä¸Šäº†ã€‚

# å•é˜¶æ®µç›®æ ‡æ£€æµ‹æ¨¡å‹YOLOv3

R-CNNç³»åˆ—ç®—æ³•éœ€è¦å…ˆäº§ç”Ÿå€™é€‰åŒºåŸŸï¼Œå†å¯¹å€™é€‰åŒºåŸŸåšåˆ†ç±»å’Œä½ç½®åæ ‡çš„é¢„æµ‹ï¼Œè¿™ç±»ç®—æ³•è¢«ç§°ä¸ºä¸¤é˜¶æ®µç›®æ ‡æ£€æµ‹ç®—æ³•ã€‚è¿‘å‡ å¹´ï¼Œå¾ˆå¤šç ”ç©¶äººå‘˜ç›¸ç»§æå‡ºä¸€ç³»åˆ—å•é˜¶æ®µçš„æ£€æµ‹ç®—æ³•ï¼Œåªéœ€è¦ä¸€ä¸ªç½‘ç»œå³å¯åŒæ—¶äº§ç”Ÿå€™é€‰åŒºåŸŸå¹¶é¢„æµ‹å‡ºç‰©ä½“çš„ç±»åˆ«å’Œä½ç½®åæ ‡ã€‚

YOLOv3ä½¿ç”¨å•ä¸ªç½‘ç»œç»“æ„ï¼Œåœ¨äº§ç”Ÿå€™é€‰åŒºåŸŸçš„åŒæ—¶å³å¯é¢„æµ‹å‡ºç‰©ä½“ç±»åˆ«å’Œä½ç½®ï¼Œä¸éœ€è¦åˆ†æˆä¸¤é˜¶æ®µæ¥å®Œæˆæ£€æµ‹ä»»åŠ¡ã€‚

## YOLOv3æ¨¡å‹è®¾è®¡æ€æƒ³

YOLOv3ç®—æ³•çš„åŸºæœ¬æ€æƒ³å¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼š

* æŒ‰ä¸€å®šè§„åˆ™åœ¨å›¾ç‰‡ä¸Šäº§ç”Ÿä¸€ç³»åˆ—çš„å€™é€‰åŒºåŸŸï¼Œç„¶åæ ¹æ®è¿™äº›å€™é€‰åŒºåŸŸä¸å›¾ç‰‡ä¸Šç‰©ä½“çœŸå®æ¡†ä¹‹é—´çš„ä½ç½®å…³ç³»å¯¹å€™é€‰åŒºåŸŸè¿›è¡Œæ ‡æ³¨ã€‚è·ŸçœŸå®æ¡†è¶³å¤Ÿæ¥è¿‘çš„é‚£äº›å€™é€‰åŒºåŸŸä¼šè¢«æ ‡æ³¨ä¸ºæ­£æ ·æœ¬ï¼ŒåŒæ—¶å°†çœŸå®æ¡†çš„ä½ç½®ä½œä¸ºæ­£æ ·æœ¬çš„ä½ç½®ç›®æ ‡ã€‚åç¦»çœŸå®æ¡†è¾ƒå¤§çš„é‚£äº›å€™é€‰åŒºåŸŸåˆ™ä¼šè¢«æ ‡æ³¨ä¸ºè´Ÿæ ·æœ¬ï¼Œè´Ÿæ ·æœ¬ä¸éœ€è¦é¢„æµ‹ä½ç½®æˆ–è€…ç±»åˆ«ã€‚
* ä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œæå–å›¾ç‰‡ç‰¹å¾å¹¶å¯¹å€™é€‰åŒºåŸŸçš„ä½ç½®å’Œç±»åˆ«è¿›è¡Œé¢„æµ‹ã€‚è¿™æ ·æ¯ä¸ªé¢„æµ‹æ¡†å°±å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªæ ·æœ¬ï¼Œæ ¹æ®çœŸå®æ¡†ç›¸å¯¹å®ƒçš„ä½ç½®å’Œç±»åˆ«è¿›è¡Œäº†æ ‡æ³¨è€Œè·å¾—æ ‡ç­¾å€¼ï¼Œé€šè¿‡ç½‘ç»œæ¨¡å‹é¢„æµ‹å…¶ä½ç½®å’Œç±»åˆ«ï¼Œå°†ç½‘ç»œé¢„æµ‹å€¼å’Œæ ‡ç­¾å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå°±å¯ä»¥å»ºç«‹èµ·æŸå¤±å‡½æ•°ã€‚

## äº§ç”Ÿå€™é€‰åŒºåŸŸ

å¦‚ä½•äº§ç”Ÿå€™é€‰åŒºåŸŸï¼Œæ˜¯æ£€æµ‹æ¨¡å‹çš„æ ¸å¿ƒè®¾è®¡æ–¹æ¡ˆã€‚ç›®å‰å¤§å¤šæ•°åŸºäºå·ç§¯ç¥ç»ç½‘ç»œçš„æ¨¡å‹æ‰€é‡‡ç”¨çš„æ–¹å¼å¤§ä½“å¦‚ä¸‹ï¼š

* æŒ‰ä¸€å®šçš„è§„åˆ™åœ¨å›¾ç‰‡ä¸Šç”Ÿæˆä¸€ç³»åˆ—ä½ç½®å›ºå®šçš„é”šæ¡†ï¼Œå°†è¿™äº›é”šæ¡†çœ‹ä½œæ˜¯å¯èƒ½çš„å€™é€‰åŒºåŸŸã€‚
* å¯¹é”šæ¡†æ˜¯å¦åŒ…å«ç›®æ ‡ç‰©ä½“è¿›è¡Œé¢„æµ‹ï¼Œå¦‚æœåŒ…å«ç›®æ ‡ç‰©ä½“ï¼Œè¿˜éœ€è¦é¢„æµ‹æ‰€åŒ…å«ç‰©ä½“çš„ç±»åˆ«ï¼Œä»¥åŠé¢„æµ‹æ¡†ç›¸å¯¹äºé”šæ¡†ä½ç½®éœ€è¦è°ƒæ•´çš„å¹…åº¦ã€‚

## ç”Ÿæˆé”šæ¡†

å°†åŸå§‹å›¾ç‰‡åˆ’åˆ†æˆğ‘šÃ—ğ‘›ä¸ªåŒºåŸŸï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŸå§‹å›¾ç‰‡é«˜åº¦ğ»=640, å®½åº¦ğ‘Š=480ï¼Œå¦‚æœæˆ‘ä»¬é€‰æ‹©å°å—åŒºåŸŸçš„å°ºå¯¸ä¸º32Ã—32ï¼Œåˆ™ğ‘šå’Œğ‘›åˆ†åˆ«ä¸ºï¼š

ğ‘š=640/32=20

ğ‘›=480/32=15

YOLOv3ç®—æ³•ä¼šåœ¨æ¯ä¸ªåŒºåŸŸçš„ä¸­å¿ƒï¼Œç”Ÿæˆä¸€ç³»åˆ—é”šæ¡†

![1715417058228](image/03ç›®æ ‡æ£€æµ‹/1715417058228.png)

## ç”Ÿæˆé¢„æµ‹æ¡†

é”šæ¡†çš„ä½ç½®éƒ½æ˜¯å›ºå®šå¥½çš„ï¼Œä¸å¯èƒ½åˆšå¥½è·Ÿç‰©ä½“è¾¹ç•Œæ¡†é‡åˆï¼Œéœ€è¦åœ¨é”šæ¡†çš„åŸºç¡€ä¸Šè¿›è¡Œä½ç½®çš„å¾®è°ƒä»¥ç”Ÿæˆé¢„æµ‹æ¡†

## å¯¹å€™é€‰åŒºåŸŸè¿›è¡Œæ ‡æ³¨

æ¯ä¸ªåŒºåŸŸå¯ä»¥äº§ç”Ÿ3ç§ä¸åŒå½¢çŠ¶çš„é”šæ¡†ï¼Œæ¯ä¸ªé”šæ¡†éƒ½æ˜¯ä¸€ä¸ªå¯èƒ½çš„å€™é€‰åŒºåŸŸ

* é”šæ¡†æ˜¯å¦åŒ…å«ç‰©ä½“ï¼Œè¿™å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ï¼Œä½¿ç”¨æ ‡ç­¾objectnessæ¥è¡¨ç¤ºã€‚å½“é”šæ¡†åŒ…å«äº†ç‰©ä½“æ—¶ï¼Œobjectness=1ï¼Œè¡¨ç¤ºé¢„æµ‹æ¡†å±äºæ­£ç±»ï¼›å½“é”šæ¡†ä¸åŒ…å«ç‰©ä½“æ—¶ï¼Œè®¾ç½®objectness=0ï¼Œè¡¨ç¤ºé”šæ¡†å±äºè´Ÿç±»ã€‚
* å¦‚æœé”šæ¡†åŒ…å«äº†ç‰©ä½“ï¼Œé‚£ä¹ˆå®ƒå¯¹åº”çš„é¢„æµ‹æ¡†çš„ä¸­å¿ƒä½ç½®å’Œå¤§å°åº”è¯¥æ˜¯å¤šå°‘ï¼Œæˆ–è€…è¯´ä¸Šé¢è®¡ç®—å¼ä¸­çš„ğ‘¡ğ‘¥,ğ‘¡ğ‘¦,ğ‘¡ğ‘¤,ğ‘¡â„åº”è¯¥æ˜¯å¤šå°‘ï¼Œä½¿ç”¨locationæ ‡ç­¾ã€‚
* å¦‚æœé”šæ¡†åŒ…å«äº†ç‰©ä½“ï¼Œé‚£ä¹ˆå…·ä½“ç±»åˆ«æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œä½¿ç”¨å˜é‡labelæ¥è¡¨ç¤ºå…¶æ‰€å±ç±»åˆ«çš„æ ‡ç­¾ã€‚

## æ ‡æ³¨é¢„æµ‹æ¡†çš„ä½ç½®åæ ‡æ ‡ç­¾

å½“é”šæ¡†objectness=1æ—¶ï¼Œéœ€è¦ç¡®å®šé¢„æµ‹æ¡†ä½ç½®ç›¸å¯¹äºå®ƒå¾®è°ƒçš„å¹…åº¦ï¼Œä¹Ÿå°±æ˜¯é”šæ¡†çš„ä½ç½®æ ‡ç­¾ã€‚

(ğ‘¡ğ‘¥,ğ‘¡ğ‘¦,ğ‘¡â„,ğ‘¡ğ‘¤)æ˜¯ç½‘ç»œé¢„æµ‹çš„è¾“å‡ºå€¼ï¼Œå°†(ğ‘‘ğ‘¥âˆ—,ğ‘‘ğ‘¦âˆ—,ğ‘¡ğ‘¤âˆ—,ğ‘¡â„âˆ—)**ä½œä¸º(ğœ(ğ‘¡ğ‘¥),ğœ(ğ‘¡ğ‘¦),ğ‘¡â„,ğ‘¡ğ‘¤)*çš„ç›®æ ‡å€¼ï¼Œä»¥å®ƒä»¬ä¹‹é—´çš„å·®è·ä½œä¸ºæŸå¤±å‡½æ•°ï¼Œåˆ™å¯ä»¥å»ºç«‹èµ·ä¸€ä¸ªå›å½’é—®é¢˜ï¼Œé€šè¿‡å­¦ä¹ ç½‘ç»œå‚æ•°ï¼Œä½¿å¾—ğ‘¡è¶³å¤Ÿæ¥è¿‘ğ‘¡ï¼Œä»è€Œèƒ½å¤Ÿæ±‚è§£å‡ºé¢„æµ‹æ¡†çš„ä½ç½®ã€‚

## æ ‡æ³¨é”šæ¡†åŒ…å«ç‰©ä½“ç±»åˆ«çš„æ ‡ç­¾

å¯¹äºobjectness=1çš„é”šæ¡†ï¼Œéœ€è¦ç¡®å®šå…¶å…·ä½“ç±»åˆ«

objectnessæ ‡æ³¨ä¸º1çš„é”šæ¡†ï¼Œä¼šæœ‰ä¸€ä¸ªçœŸå®æ¡†è·Ÿå®ƒå¯¹åº”ï¼Œè¯¥é”šæ¡†æ‰€å±ç‰©ä½“ç±»åˆ«ï¼Œå³æ˜¯å…¶æ‰€å¯¹åº”çš„çœŸå®æ¡†åŒ…å«çš„ç‰©ä½“ç±»åˆ«

ä½¿ç”¨one-hotå‘é‡æ¥è¡¨ç¤ºç±»åˆ«æ ‡ç­¾labelã€‚æ¯”å¦‚ä¸€å…±æœ‰10ä¸ªåˆ†ç±»ï¼Œè€ŒçœŸå®æ¡†é‡Œé¢åŒ…å«çš„ç‰©ä½“ç±»åˆ«æ˜¯ç¬¬2ç±»ï¼Œåˆ™labelä¸º(0,1,0,0,0,0,0,0,0,0)

![1715565030589](image/03ç›®æ ‡æ£€æµ‹/1715565030589.png)

å¯¹äºæ¯ä¸ªé”šæ¡†ï¼Œæ¨¡å‹éœ€è¦é¢„æµ‹è¾“å‡º(ğ‘¡ğ‘¥,ğ‘¡ğ‘¦,ğ‘¡ğ‘¤,ğ‘¡â„,ğ‘ƒğ‘œğ‘ğ‘—,ğ‘ƒ1,ğ‘ƒ2,...,ğ‘ƒğ¶)ï¼Œå…¶ä¸­ğ‘ƒğ‘œğ‘ğ‘—æ˜¯é”šæ¡†æ˜¯å¦åŒ…å«ç‰©ä½“çš„æ¦‚ç‡ï¼Œğ‘ƒ1,ğ‘ƒ2,...,ğ‘ƒğ¶åˆ™æ˜¯é”šæ¡†åŒ…å«çš„ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡

## æ ‡æ³¨é”šæ¡†çš„å…·ä½“ç¨‹åº

ä¸Šé¢æè¿°äº†å¦‚ä½•å¯¹é¢„é”šæ¡†è¿›è¡Œæ ‡æ³¨ï¼Œä½†è¯»è€…å¯èƒ½ä»ç„¶å¯¹é‡Œé¢çš„ç»†èŠ‚ä¸å¤ªäº†è§£ï¼Œä¸‹é¢å°†é€šè¿‡å…·ä½“çš„ç¨‹åºå®Œæˆè¿™ä¸€æ­¥éª¤ã€‚

```
# æ ‡æ³¨é¢„æµ‹æ¡†çš„objectness
def get_objectness_label(img, gt_boxes, gt_labels, iou_threshold = 0.7,
                         anchors = [116, 90, 156, 198, 373, 326],
                         num_classes=7, downsample=32):
    """
    img æ˜¯è¾“å…¥çš„å›¾åƒæ•°æ®ï¼Œå½¢çŠ¶æ˜¯[N, C, H, W]
    gt_boxesï¼ŒçœŸå®æ¡†ï¼Œç»´åº¦æ˜¯[N, 50, 4]ï¼Œå…¶ä¸­50æ˜¯çœŸå®æ¡†æ•°ç›®çš„ä¸Šé™ï¼Œå½“å›¾ç‰‡ä¸­çœŸå®æ¡†ä¸è¶³50ä¸ªæ—¶ï¼Œä¸è¶³éƒ¨åˆ†çš„åæ ‡å…¨ä¸º0
              çœŸå®æ¡†åæ ‡æ ¼å¼æ˜¯xywhï¼Œè¿™é‡Œä½¿ç”¨ç›¸å¯¹å€¼
    gt_labelsï¼ŒçœŸå®æ¡†æ‰€å±ç±»åˆ«ï¼Œç»´åº¦æ˜¯[N, 50]
    iou_thresholdï¼Œå½“é¢„æµ‹æ¡†ä¸çœŸå®æ¡†çš„iouå¤§äºiou_thresholdæ—¶ä¸å°†å…¶çœ‹ä½œæ˜¯è´Ÿæ ·æœ¬
    anchorsï¼Œé”šæ¡†å¯é€‰çš„å°ºå¯¸
    anchor_masksï¼Œé€šè¿‡ä¸anchorsä¸€èµ·ç¡®å®šæœ¬å±‚çº§çš„ç‰¹å¾å›¾åº”è¯¥é€‰ç”¨å¤šå¤§å°ºå¯¸çš„é”šæ¡†
    num_classesï¼Œç±»åˆ«æ•°ç›®
    downsampleï¼Œç‰¹å¾å›¾ç›¸å¯¹äºè¾“å…¥ç½‘ç»œçš„å›¾ç‰‡å°ºå¯¸å˜åŒ–çš„æ¯”ä¾‹
    """

    img_shape = img.shape
    batchsize = img_shape[0]
    num_anchors = len(anchors) // 2
    input_h = img_shape[2]
    input_w = img_shape[3]
    # å°†è¾“å…¥å›¾ç‰‡åˆ’åˆ†æˆnum_rows x num_colsä¸ªå°æ–¹å—åŒºåŸŸï¼Œæ¯ä¸ªå°æ–¹å—çš„è¾¹é•¿æ˜¯ downsample
    # è®¡ç®—ä¸€å…±æœ‰å¤šå°‘è¡Œå°æ–¹å—
    num_rows = input_h // downsample
    # è®¡ç®—ä¸€å…±æœ‰å¤šå°‘åˆ—å°æ–¹å—
    num_cols = input_w // downsample

    label_objectness = np.zeros([batchsize, num_anchors, num_rows, num_cols])
    label_classification = np.zeros([batchsize, num_anchors, num_classes, num_rows, num_cols])
    label_location = np.zeros([batchsize, num_anchors, 4, num_rows, num_cols])

    scale_location = np.ones([batchsize, num_anchors, num_rows, num_cols])

    # å¯¹batchsizeè¿›è¡Œå¾ªç¯ï¼Œä¾æ¬¡å¤„ç†æ¯å¼ å›¾ç‰‡
    for n in range(batchsize):
        # å¯¹å›¾ç‰‡ä¸Šçš„çœŸå®æ¡†è¿›è¡Œå¾ªç¯ï¼Œä¾æ¬¡æ‰¾å‡ºè·ŸçœŸå®æ¡†å½¢çŠ¶æœ€åŒ¹é…çš„é”šæ¡†
        for n_gt in range(len(gt_boxes[n])):
            gt = gt_boxes[n][n_gt]
            gt_cls = gt_labels[n][n_gt]
            gt_center_x = gt[0]
            gt_center_y = gt[1]
            gt_width = gt[2]
            gt_height = gt[3]
            if (gt_width < 1e-3) or (gt_height < 1e-3):
                continue
            i = int(gt_center_y * num_rows)
            j = int(gt_center_x * num_cols)
            ious = []
            for ka in range(num_anchors):
                bbox1 = [0., 0., float(gt_width), float(gt_height)]
                anchor_w = anchors[ka * 2]
                anchor_h = anchors[ka * 2 + 1]
                bbox2 = [0., 0., anchor_w/float(input_w), anchor_h/float(input_h)]
                # è®¡ç®—iou
                iou = box_iou_xywh(bbox1, bbox2)
                ious.append(iou)
            ious = np.array(ious)
            inds = np.argsort(ious)
            k = inds[-1]
            label_objectness[n, k, i, j] = 1
            c = gt_cls
            label_classification[n, k, c, i, j] = 1.

            # for those prediction bbox with objectness =1, set label of location
            dx_label = gt_center_x * num_cols - j
            dy_label = gt_center_y * num_rows - i
            dw_label = np.log(gt_width * input_w / anchors[k*2])
            dh_label = np.log(gt_height * input_h / anchors[k*2 + 1])
            label_location[n, k, 0, i, j] = dx_label
            label_location[n, k, 1, i, j] = dy_label
            label_location[n, k, 2, i, j] = dw_label
            label_location[n, k, 3, i, j] = dh_label
            # scale_locationç”¨æ¥è°ƒèŠ‚ä¸åŒå°ºå¯¸çš„é”šæ¡†å¯¹æŸå¤±å‡½æ•°çš„è´¡çŒ®ï¼Œä½œä¸ºåŠ æƒç³»æ•°å’Œä½ç½®æŸå¤±å‡½æ•°ç›¸ä¹˜
            scale_location[n, k, i, j] = 2.0 - gt_width * gt_height

    # ç›®å‰æ ¹æ®æ¯å¼ å›¾ç‰‡ä¸Šæ‰€æœ‰å‡ºç°è¿‡çš„gt boxï¼Œéƒ½æ ‡æ³¨å‡ºäº†objectnessä¸ºæ­£çš„é¢„æµ‹æ¡†ï¼Œå‰©ä¸‹çš„é¢„æµ‹æ¡†åˆ™é»˜è®¤objectnessä¸º0
    # å¯¹äºobjectnessä¸º1çš„é¢„æµ‹æ¡†ï¼Œæ ‡å‡ºäº†ä»–ä»¬æ‰€åŒ…å«çš„ç‰©ä½“ç±»åˆ«ï¼Œä»¥åŠä½ç½®å›å½’çš„ç›®æ ‡
    return label_objectness.astype('float32'), label_location.astype('float32'), label_classification.astype('float32'), \
             scale_location.astype('float32')
```

```
# è®¡ç®—IoUï¼ŒçŸ©å½¢æ¡†çš„åæ ‡å½¢å¼ä¸ºxywh
def box_iou_xywh(box1, box2):
    x1min, y1min = box1[0] - box1[2]/2.0, box1[1] - box1[3]/2.0
    x1max, y1max = box1[0] + box1[2]/2.0, box1[1] + box1[3]/2.0
    s1 = box1[2] * box1[3]

    x2min, y2min = box2[0] - box2[2]/2.0, box2[1] - box2[3]/2.0
    x2max, y2max = box2[0] + box2[2]/2.0, box2[1] + box2[3]/2.0
    s2 = box2[2] * box2[3]

    xmin = np.maximum(x1min, x2min)
    ymin = np.maximum(y1min, y2min)
    xmax = np.minimum(x1max, x2max)
    ymax = np.minimum(y1max, y2max)
    inter_h = np.maximum(ymax - ymin, 0.)
    inter_w = np.maximum(xmax - xmin, 0.)
    intersection = inter_h * inter_w

    union = s1 + s2 - intersection
    iou = intersection / union
    return iou 
```

```
# è¯»å–æ•°æ®
import paddle
reader = paddle.io.DataLoader(train_dataset, batch_size=2, shuffle=True, num_workers=1, drop_last=True)
img, gt_boxes, gt_labels, im_shape = next(reader())
img, gt_boxes, gt_labels, im_shape = img.numpy(), gt_boxes.numpy(), gt_labels.numpy(), im_shape.numpy()

# è®¡ç®—å‡ºé”šæ¡†å¯¹åº”çš„æ ‡ç­¾
label_objectness, label_location, label_classification, scale_location = get_objectness_label(img,
                                                                                              gt_boxes, gt_labels, 
                                                                                              iou_threshold = 0.7,
                                                                                              anchors = [116, 90, 156, 198, 373, 326],
                                                                                              num_classes=7, downsample=32)
```

ä¸Šé¢çš„ç¨‹åºå®ç°äº†å¯¹é”šæ¡†è¿›è¡Œæ ‡æ³¨ï¼Œå¯¹äºæ¯ä¸ªçœŸå®æ¡†ï¼Œé€‰å‡ºäº†ä¸å®ƒå½¢çŠ¶æœ€åŒ¹é…çš„é”šæ¡†ï¼Œå°†å…¶objectnessæ ‡æ³¨ä¸º1ï¼Œå¹¶ä¸”å°†[ğ‘‘ğ‘¥âˆ—,ğ‘‘ğ‘¦âˆ—,ğ‘¡â„âˆ—,ğ‘¡ğ‘¤âˆ—]ä½œä¸ºæ­£æ ·æœ¬ä½ç½®çš„æ ‡ç­¾ï¼ŒçœŸå®æ¡†åŒ…å«çš„ç‰©ä½“ç±»åˆ«ä½œä¸ºé”šæ¡†çš„ç±»åˆ«ã€‚è€Œå…¶ä½™çš„é”šæ¡†ï¼Œobjectnesså°†è¢«æ ‡æ³¨ä¸º0ï¼Œæ— éœ€æ ‡æ³¨å‡ºä½ç½®å’Œç±»åˆ«çš„æ ‡ç­¾ã€‚

## å·ç§¯ç¥ç»ç½‘ç»œæå–ç‰¹å¾

é€šè¿‡è¿ç»­ä½¿ç”¨å¤šå±‚å·ç§¯å’Œæ± åŒ–ç­‰æ“ä½œï¼Œèƒ½å¾—åˆ°è¯­ä¹‰å«ä¹‰æ›´åŠ ä¸°å¯Œçš„ç‰¹å¾å›¾ã€‚åœ¨æ£€æµ‹é—®é¢˜ä¸­ï¼Œä¹Ÿä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œé€å±‚æå–å›¾åƒç‰¹å¾ï¼Œé€šè¿‡æœ€ç»ˆçš„è¾“å‡ºç‰¹å¾å›¾æ¥è¡¨å¾ç‰©ä½“ä½ç½®å’Œç±»åˆ«ç­‰ä¿¡æ¯ã€‚

YOLOv3ç®—æ³•ä½¿ç”¨çš„éª¨å¹²ç½‘ç»œæ˜¯Darknet53

åœ¨æ£€æµ‹ä»»åŠ¡ä¸­ï¼Œå°†å›¾ä¸­C0åé¢çš„å¹³å‡æ± åŒ–ã€å…¨è¿æ¥å±‚å’ŒSoftmaxå»æ‰ï¼Œä¿ç•™ä»è¾“å…¥åˆ°C0éƒ¨åˆ†çš„ç½‘ç»œç»“æ„ï¼Œä½œä¸ºæ£€æµ‹æ¨¡å‹çš„åŸºç¡€ç½‘ç»œç»“æ„ï¼Œä¹Ÿç§°ä¸ºéª¨å¹²ç½‘ç»œã€‚YOLOv3æ¨¡å‹ä¼šåœ¨éª¨å¹²ç½‘ç»œçš„åŸºç¡€ä¸Šï¼Œå†æ·»åŠ æ£€æµ‹ç›¸å…³çš„ç½‘ç»œæ¨¡å—ã€‚

![1715566784167](image/03ç›®æ ‡æ£€æµ‹/1715566784167.png)

ä¸‹é¢çš„ç¨‹åºæ˜¯Darknet53éª¨å¹²ç½‘ç»œçš„å®ç°ä»£ç 

```
import paddle
import paddle.nn.functional as F
import numpy as np

class ConvBNLayer(paddle.nn.Layer):
    def __init__(self, ch_in, ch_out, 
                 kernel_size=3, stride=1, groups=1,
                 padding=0, act="leaky"):
        super(ConvBNLayer, self).__init__()
  
        self.conv = paddle.nn.Conv2D(
            in_channels=ch_in,
            out_channels=ch_out,
            kernel_size=kernel_size,
            stride=stride,
            padding=padding,
            groups=groups,
            weight_attr=paddle.ParamAttr(
                initializer=paddle.nn.initializer.Normal(0., 0.02)),
            bias_attr=False)
  
        self.batch_norm = paddle.nn.BatchNorm2D(
            num_features=ch_out,
            weight_attr=paddle.ParamAttr(
                initializer=paddle.nn.initializer.Normal(0., 0.02),
                regularizer=paddle.regularizer.L2Decay(0.)),
            bias_attr=paddle.ParamAttr(
                initializer=paddle.nn.initializer.Constant(0.0),
                regularizer=paddle.regularizer.L2Decay(0.)))
        self.act = act

  
    def forward(self, inputs):
        out = self.conv(inputs)
        out = self.batch_norm(out)
        if self.act == 'leaky':
            out = F.leaky_relu(x=out, negative_slope=0.1)
        return out
  
class DownSample(paddle.nn.Layer):
    # ä¸‹é‡‡æ ·ï¼Œå›¾ç‰‡å°ºå¯¸å‡åŠï¼Œå…·ä½“å®ç°æ–¹å¼æ˜¯ä½¿ç”¨stirde=2çš„å·ç§¯
    def __init__(self,
                 ch_in,
                 ch_out,
                 kernel_size=3,
                 stride=2,
                 padding=1):

        super(DownSample, self).__init__()

        self.conv_bn_layer = ConvBNLayer(
            ch_in=ch_in,
            ch_out=ch_out,
            kernel_size=kernel_size,
            stride=stride,
            padding=padding)
        self.ch_out = ch_out
    def forward(self, inputs):
        out = self.conv_bn_layer(inputs)
        return out

class BasicBlock(paddle.nn.Layer):
    """
    åŸºæœ¬æ®‹å·®å—çš„å®šä¹‰ï¼Œè¾“å…¥xç»è¿‡ä¸¤å±‚å·ç§¯ï¼Œç„¶åæ¥ç¬¬äºŒå±‚å·ç§¯çš„è¾“å‡ºå’Œè¾“å…¥xç›¸åŠ 
    """
    def __init__(self, ch_in, ch_out):
        super(BasicBlock, self).__init__()

        self.conv1 = ConvBNLayer(
            ch_in=ch_in,
            ch_out=ch_out,
            kernel_size=1,
            stride=1,
            padding=0
            )
        self.conv2 = ConvBNLayer(
            ch_in=ch_out,
            ch_out=ch_out*2,
            kernel_size=3,
            stride=1,
            padding=1
            )
    def forward(self, inputs):
        conv1 = self.conv1(inputs)
        conv2 = self.conv2(conv1)
        out = paddle.add(x=inputs, y=conv2)
        return out

   
class LayerWarp(paddle.nn.Layer):
    """
    æ·»åŠ å¤šå±‚æ®‹å·®å—ï¼Œç»„æˆDarknet53ç½‘ç»œçš„ä¸€ä¸ªå±‚çº§
    """
    def __init__(self, ch_in, ch_out, count, is_test=True):
        super(LayerWarp,self).__init__()

        self.basicblock0 = BasicBlock(ch_in,
            ch_out)
        self.res_out_list = []
        for i in range(1, count):
            res_out = self.add_sublayer("basic_block_%d" % (i), # ä½¿ç”¨add_sublayeræ·»åŠ å­å±‚
                BasicBlock(ch_out*2,
                    ch_out))
            self.res_out_list.append(res_out)

    def forward(self,inputs):
        y = self.basicblock0(inputs)
        for basic_block_i in self.res_out_list:
            y = basic_block_i(y)
        return y

# DarkNet æ¯ç»„æ®‹å·®å—çš„ä¸ªæ•°ï¼Œæ¥è‡ªDarkNetçš„ç½‘ç»œç»“æ„å›¾
DarkNet_cfg = {53: ([1, 2, 8, 8, 4])}

class DarkNet53_conv_body(paddle.nn.Layer):
    def __init__(self):
        super(DarkNet53_conv_body, self).__init__()
        self.stages = DarkNet_cfg[53]
        self.stages = self.stages[0:5]

        # ç¬¬ä¸€å±‚å·ç§¯
        self.conv0 = ConvBNLayer(
            ch_in=3,
            ch_out=32,
            kernel_size=3,
            stride=1,
            padding=1)

        # ä¸‹é‡‡æ ·ï¼Œä½¿ç”¨stride=2çš„å·ç§¯æ¥å®ç°
        self.downsample0 = DownSample(
            ch_in=32,
            ch_out=32 * 2)

        # æ·»åŠ å„ä¸ªå±‚çº§çš„å®ç°
        self.darknet53_conv_block_list = []
        self.downsample_list = []
        for i, stage in enumerate(self.stages):
            conv_block = self.add_sublayer(
                "stage_%d" % (i),
                LayerWarp(32*(2**(i+1)),
                32*(2**i),
                stage))
            self.darknet53_conv_block_list.append(conv_block)
        # ä¸¤ä¸ªå±‚çº§ä¹‹é—´ä½¿ç”¨DownSampleå°†å°ºå¯¸å‡åŠ
        for i in range(len(self.stages) - 1):
            downsample = self.add_sublayer(
                "stage_%d_downsample" % i,
                DownSample(ch_in=32*(2**(i+1)),
                    ch_out=32*(2**(i+2))))
            self.downsample_list.append(downsample)

    def forward(self,inputs):
        out = self.conv0(inputs)
        #print("conv1:",out.numpy())
        out = self.downsample0(out)
        #print("dy:",out.numpy())
        blocks = []
        for i, conv_block_i in enumerate(self.darknet53_conv_block_list): #ä¾æ¬¡å°†å„ä¸ªå±‚çº§ä½œç”¨åœ¨è¾“å…¥ä¸Šé¢
            out = conv_block_i(out)
            blocks.append(out)
            if i < len(self.stages) - 1:
                out = self.downsample_list[i](out)
        return blocks[-1:-4:-1] # å°†C0, C1, C2ä½œä¸ºè¿”å›å€¼
```

```
# æŸ¥çœ‹Darknet53ç½‘ç»œè¾“å‡ºç‰¹å¾å›¾
import numpy as np
backbone = DarkNet53_conv_body()
x = np.random.randn(1, 3, 640, 640).astype('float32')
x = paddle.to_tensor(x)
C0, C1, C2 = backbone(x)
print(C0.shape, C1.shape, C2.shape)
```

ä¸Šé¢è¿™æ®µç¤ºä¾‹ä»£ç ï¼ŒæŒ‡å®šè¾“å…¥æ•°æ®çš„å½¢çŠ¶æ˜¯(1,3,640,640)**ï¼Œåˆ™3ä¸ªå±‚çº§çš„è¾“å‡ºç‰¹å¾å›¾çš„å½¢çŠ¶åˆ†åˆ«æ˜¯ğ¶0(1,1024,20,20)**ï¼Œğ¶1(1,512,40,40)**å’Œğ¶2(1,256,80,80)**ã€‚

## æ ¹æ®è¾“å‡ºç‰¹å¾å›¾è®¡ç®—é¢„æµ‹æ¡†ä½ç½®å’Œç±»åˆ«

YOLOv3ä¸­å¯¹æ¯ä¸ªé¢„æµ‹æ¡†è®¡ç®—é€»è¾‘å¦‚ä¸‹ï¼š

* é¢„æµ‹æ¡†æ˜¯å¦åŒ…å«ç‰©ä½“ã€‚ä¹Ÿå¯ç†è§£ä¸ºobjectness=1çš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Œå¯ä»¥ç”¨ç½‘ç»œè¾“å‡ºä¸€ä¸ªå®æ•°ğ‘¥ï¼Œå¯ä»¥ç”¨ğ‘†ğ‘–ğ‘”ğ‘šğ‘œğ‘–ğ‘‘(ğ‘¥)è¡¨ç¤ºobjectnessä¸ºæ­£çš„æ¦‚ç‡ğ‘ƒğ‘œğ‘ğ‘—
* é¢„æµ‹ç‰©ä½“ä½ç½®å’Œå½¢çŠ¶ã€‚ç‰©ä½“ä½ç½®å’Œå½¢çŠ¶ğ‘¡ğ‘¥,ğ‘¡ğ‘¦,ğ‘¡ğ‘¤,ğ‘¡â„å¯ä»¥ç”¨ç½‘ç»œè¾“å‡º4ä¸ªå®æ•°æ¥è¡¨ç¤ºğ‘¡ğ‘¥,ğ‘¡ğ‘¦,ğ‘¡ğ‘¤,ğ‘¡â„
* é¢„æµ‹ç‰©ä½“ç±»åˆ«ã€‚é¢„æµ‹å›¾åƒä¸­ç‰©ä½“çš„å…·ä½“ç±»åˆ«æ˜¯ä»€ä¹ˆï¼Œæˆ–è€…è¯´å…¶å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡åˆ†åˆ«æ˜¯å¤šå°‘ã€‚æ€»çš„ç±»åˆ«æ•°ä¸ºCï¼Œéœ€è¦é¢„æµ‹ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡(ğ‘ƒ1,ğ‘ƒ2,...,ğ‘ƒğ¶)ï¼Œå¯ä»¥ç”¨ç½‘ç»œè¾“å‡ºCä¸ªå®æ•°(ğ‘¥1,ğ‘¥2,...,ğ‘¥ğ¶)ï¼Œå¯¹æ¯ä¸ªå®æ•°åˆ†åˆ«æ±‚Sigmoidå‡½æ•°ï¼Œè®©ğ‘ƒğ‘–=ğ‘†ğ‘–ğ‘”ğ‘šğ‘œğ‘–ğ‘‘(ğ‘¥ğ‘–)ï¼Œåˆ™å¯ä»¥è¡¨ç¤ºå‡ºç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚

å¯¹äºä¸€ä¸ªé¢„æµ‹æ¡†ï¼Œç½‘ç»œéœ€è¦è¾“å‡º(5+ğ¶)ä¸ªå®æ•°æ¥è¡¨å¾å®ƒæ˜¯å¦åŒ…å«ç‰©ä½“ã€ä½ç½®å’Œå½¢çŠ¶å°ºå¯¸ä»¥åŠå±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚

## å»ºç«‹è¾“å‡ºç‰¹å¾å›¾ä¸é¢„æµ‹æ¡†ä¹‹é—´çš„å…³è”

ç»è¿‡å¤šæ¬¡å·ç§¯æ ¸æ± åŒ–ä¹‹åï¼Œå…¶æ­¥å¹…stride=32ï¼Œ640Ã—480å¤§å°çš„è¾“å…¥å›¾ç‰‡å˜æˆäº†20Ã—15**çš„ç‰¹å¾å›¾ï¼›è€Œå°æ–¹å—åŒºåŸŸçš„æ•°ç›®æ­£å¥½æ˜¯20Ã—15**ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è®©ç‰¹å¾å›¾ä¸Šæ¯ä¸ªåƒç´ ç‚¹åˆ†åˆ«è·ŸåŸå›¾ä¸Šä¸€ä¸ªå°æ–¹å—åŒºåŸŸå¯¹åº”ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ€å¼€å§‹å°†å°æ–¹å—åŒºåŸŸçš„å°ºå¯¸è®¾ç½®ä¸º32çš„åŸå› ã€‚
